#!/bin/bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -u # stop on unset variables
set -e # stop on error

indent() {
  sed -u 's/^/       /'
}

function topic() {
  echo "-----> $*"
}

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

TESTSSL_VERSION="3.0.7"
TESTSSL_URL="https://github.com/drwetter/testssl.sh/raw/v${TESTSSL_VERSION}/testssl.sh"
TESTSSL_BASE_PATH="$BUILD_DIR/.heroku/testssl/bin"
TESTSSL_PATH="$TESTSSL_BASE_PATH/testssl.sh"

mkdir -p "$TESTSSL_BASE_PATH"

topic "Downloading testssl.sh v$TESTSSL_VERSION" | indent
curl --silent --retry 5 --location $TESTSSL_URL --output $TESTSSL_PATH
chmod u+x $TESTSSL_PATH

# give environment to later buildpacks
echo "export PATH=\"\$PATH:$TESTSSL_BASE_PATH\"" > $BP_DIR/export

topic "Writing profile script" | indent
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$PATH:$TESTSSL_BASE_PATH\"" > $BUILD_DIR/.profile.d/testssl-path.sh

topic "Testing testssl.sh v$TESTSSL_VERSION" | indent
WARNINGS=off $TESTSSL_PATH --version
